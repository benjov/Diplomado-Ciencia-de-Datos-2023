---
title: "4.1.1 Regresión lineal múltiple con datos de publicidad en medios de comunicación."
author: "Benjamin Oliva"
date: "07/01/2024"
output: html_document
---

```{r setup, include=FALSE, message=FALSE}
#include = FALSE prevents code and results from appearing in the finished file. R Markdown still runs the code in the chunk, and the results can be used by other chunks.
#echo = FALSE prevents code, but not the results from appearing in the finished file. This is a useful way to embed figures.
#message = FALSE prevents messages that are generated by code from appearing in the finished file.
#warning = FALSE prevents warnings that are generated by code from appearing in the finished.
#fig.cap = "..." adds a caption to graphical results.

knitr::opts_chunk$set(echo = TRUE)

#install.packages("ggplot2")
#install.packages("hrbrthemes")
#install.packages("dplyr")
#install.packages("reshape2")
#install.packages("glmtoolbox") # Biblioteca que contiene los datos de Hastie, et. al (2013)
#install.packages("stats")
#install.packages("caret")
#
library(ggplot2)
library(hrbrthemes)
library(dplyr)
library(reshape2)
library(glmtoolbox)
library(stats)
library(caret)
```

#  Data
Descripción: El conjunto de datos publicitarios consta de las ventas de un producto en 200 mercados diferentes. También incluye presupuestos de publicidad del producto en cada uno de esos mercados para tres medios diferentes: TV, radio y periódicos.
Es decir, los datos son 200 filas y 4 variables:

Fuente: James G., Witten D., Hastie T., Tibshirani R. (2013, page 15) An Introduction to Statistical Learning with Applications in R, Springer, New York. https://www.statlearning.com/s/Advertising.csv
```{r data}

data(advertising)

tail(advertising)

```

```{r Melt}

advertising_2 <- melt(advertising, id='sales')

names(advertising_2) <- c("Sales", "Chanel", "Advertising")

tail(advertising_2)

```


```{r plot}

ggplot(data = advertising_2, aes(x = Advertising, y = Sales, color = Chanel)) + 
  geom_point(size = 2) +
  theme_ipsum() + #theme_bw() 
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank()) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE)) + 
  xlab("Gasto en publicidad") + 
  ylab("Ventas") + 
  theme(plot.title = element_text(size = 11, face = "bold", hjust = 0)) + 
  theme(plot.subtitle = element_text(size = 10, hjust = 0)) + 
  theme(plot.caption = element_text(hjust = 0)) +
  theme(plot.margin = unit(c(1,1,1,1), "cm")) +
  labs(
    title = "Relación entre el gasto en publicidad y las ventas",
    subtitle = "Valores en pesos",
    caption = "Fuente: Elaboración propia con informción de \nURL: https://www.statlearning.com/s/Advertising.csv"
  )

#ggsave("G_Advertising.png", width = 20, height = 10, units = "cm")
```

```{r plot_TV}

ggplot(data = advertising_2[ which(advertising_2$Chanel== 'TV'), ], 
       aes(x = Advertising, y = Sales)) + 
  geom_point(size = 2, color = 'darkred') +
  theme_ipsum() + #theme_bw() 
  theme(legend.position = "none") +
  theme(legend.title = element_blank()) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE)) + 
  xlab("Gasto en publicidad") + 
  ylab("Ventas") + 
  theme(plot.title = element_text(size = 11, face = "bold", hjust = 0)) + 
  theme(plot.subtitle = element_text(size = 10, hjust = 0)) + 
  theme(plot.caption = element_text(hjust = 0)) +
  theme(plot.margin = unit(c(1,1,1,1), "cm")) +
  labs(
    title = "Relación entre el gasto en publicidad en TV y las ventas",
    subtitle = "Valores en pesos",
    caption = "Fuente: Elaboración propia con informción de \nURL: https://www.statlearning.com/s/Advertising.csv"
  )

#ggsave("G_Advertising_TV.png", width = 20, height = 10, units = "cm")
```

```{r plot_radio}

ggplot(data = advertising_2[ which(advertising_2$Chanel== 'radio'), ], 
       aes(x = Advertising, y = Sales)) + 
  geom_point(size = 2, color = 'darkblue') +
  theme_ipsum() + #theme_bw() 
  theme(legend.position = "none") +
  theme(legend.title = element_blank()) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE)) + 
  xlab("Gasto en publicidad") + 
  ylab("Ventas") + 
  theme(plot.title = element_text(size = 11, face = "bold", hjust = 0)) + 
  theme(plot.subtitle = element_text(size = 10, hjust = 0)) + 
  theme(plot.caption = element_text(hjust = 0)) +
  theme(plot.margin = unit(c(1,1,1,1), "cm")) +
  labs(
    title = "Relación entre el gasto en publicidad en radio y las ventas",
    subtitle = "Valores en pesos",
    caption = "Fuente: Elaboración propia con informción de \nURL: https://www.statlearning.com/s/Advertising.csv"
  )

#ggsave("G_Advertising_radio.png", width = 20, height = 10, units = "cm")
```

```{r plot_newspaper}

ggplot(data = advertising_2[ which(advertising_2$Chanel== 'newspaper'), ], 
       aes(x = Advertising, y = Sales)) + 
  geom_point(size = 2, color = 'darkgreen') +
  theme_ipsum() + #theme_bw() 
  theme(legend.position = "none") +
  theme(legend.title = element_blank()) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE)) + 
  xlab("Gasto en publicidad") + 
  ylab("Ventas") + 
  theme(plot.title = element_text(size = 11, face = "bold", hjust = 0)) + 
  theme(plot.subtitle = element_text(size = 10, hjust = 0)) + 
  theme(plot.caption = element_text(hjust = 0)) +
  theme(plot.margin = unit(c(1,1,1,1), "cm")) +
  labs(
    title = "Relación entre el gasto en publicidad en periódicos y las ventas",
    subtitle = "Valores en pesos",
    caption = "Fuente: Elaboración propia con informción de \nURL: https://www.statlearning.com/s/Advertising.csv"
  )

#ggsave("G_Advertising_newspaper.png", width = 20, height = 10, units = "cm")
```

# Primera estimación

```{r Summary}

summary(advertising)

```

```{r Reg_01}

Reg_01 <- lm(sales ~ TV + radio + newspaper, 
             data = advertising)

summary(Reg_01)

```


```{r Reg_02}

Reg_02 <- lm( sales ~ TV + I(TV^2) + I(TV^3) +
                     radio + newspaper, 
             data = advertising)

summary(Reg_02)

```


```{r Reg_03}

Reg_03 <- lm( sales ~ TV + I(TV^2) + I(TV^3) +
                     radio + I(radio^2) + I(radio^3) +  
                     newspaper + I(newspaper^2) + I(newspaper^3), 
             data = advertising)

summary(Reg_03)

```

```{r Predicciones}

advertising$Reg_01 <- predict( Reg_01, advertising )

advertising$Reg_02 <- predict( Reg_02, advertising )

advertising$Reg_03 <- predict( Reg_03, advertising )

advertising_3 <- melt(advertising[ , c("sales", "Reg_01", "Reg_02", "Reg_03")], 
                      id='sales')

names(advertising_3) <- c("Sales", "Model", "Predict")

tail(advertising_3)
```

```{r plot_Compara}

ggplot(data = advertising_3, aes(x = Predict, y = Sales, color = Model)) + 
  geom_point(size = 2, alpha = 0.5) +
  theme_ipsum() + #theme_bw() 
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank()) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE)) + 
  xlab("Gasto en publicidad") + 
  ylab("Ventas") + 
  theme(plot.title = element_text(size = 11, face = "bold", hjust = 0)) + 
  theme(plot.subtitle = element_text(size = 10, hjust = 0)) + 
  theme(plot.caption = element_text(hjust = 0)) +
  theme(plot.margin = unit(c(1,1,1,1), "cm")) +
  labs(
    title = "Comparación del desempeño de los modelos",
    subtitle = "Valores en pesos",
    caption = "Fuente: Elaboración propia."
  )

```

## Cuadro Resultados de los Modelos

```{r R_Sqrt}
#
  sst <- sum( ( advertising$sales - mean( advertising$sales ) )^2 , na.rm = TRUE)
  
  sse_Reg_01 <- sum( ( advertising$Reg_01 - advertising$sales )^2 , na.rm = TRUE)
  
  sse_Reg_02 <- sum( ( advertising$Reg_02 - advertising$sales )^2 , na.rm = TRUE)
  
  sse_Reg_03 <- sum( ( advertising$Reg_03 - advertising$sales )^2 , na.rm = TRUE)
   
  
  Results_Models <- data.frame( Modelo = c( "Model", "Model Poly(3-TV)", "Model Poly(3-All)"), 
                                R.Sqrt_Est = c( 1 - sse_Reg_01/sst,
                                                1 - sse_Reg_02/sst,
                                                1 - sse_Reg_03/sst ) )
  
Results_Models  

```

# Estimación MACHINE LEARNING (ML)

```{r Split_Data}

set.seed(1234) # 
  
trainIndex <- createDataPartition( advertising$sales , 
                                   p = 0.7 , times = 1, list = FALSE )
  
advertising_Train <- advertising[ trainIndex , ]
  
advertising_Valid <- advertising[ -trainIndex , ]

```

```{r Split_Data_Summ}

summary(advertising_Train[ , c("sales", "TV", "radio", "newspaper")])
  
summary(advertising_Valid[ , c("sales", "TV", "radio", "newspaper")])

```

```{r Reg_Train}

Reg_Train <- lm( sales ~ TV + I(TV^2) + I(TV^3) +
                     radio + newspaper, 
             data = advertising_Train)

summary(Reg_Train)

```

```{r Predicciones_ML}

advertising$Reg_OverAll <- predict( Reg_Train, advertising )

advertising_Train$Reg_OverTrain <- predict( Reg_Train, advertising_Train )

advertising_Valid$Reg_OverValid <- predict( Reg_Train, advertising_Valid )

```

## Cuadro Resultados / Desempeño del Modelo ML

```{r R_Sqrt_ML}

sst_OverAll <- sum( ( advertising$sales - mean( advertising$sales ) )^2 , na.rm = TRUE)
  
sse_Reg_OverAll <- sum( ( advertising$Reg_OverAll - advertising$sales )^2 , na.rm = TRUE)
  
sst_OverTrain <- sum( ( advertising_Train$sales - mean( advertising_Train$sales ) )^2 , na.rm = TRUE)
  
sse_Reg_OverTrain <- sum( ( advertising_Train$Reg_OverTrain - advertising_Train$sales )^2 , na.rm = TRUE)
   
sst_OverValid <- sum( ( advertising_Valid$sales - mean( advertising_Valid$sales ) )^2 , na.rm = TRUE)
  
sse_Reg_OverValid <- sum( ( advertising_Valid$Reg_OverValid - advertising_Valid$sales )^2 , na.rm = TRUE)

  Results_Models <- data.frame( Modelo = c( "Muestra Total", "Muestra de Entrenamiento", "Muestra de Validación"), 
                                R.Sqrt_Est = c( 1 - sse_Reg_OverAll/sst_OverAll,
                                                1 - sse_Reg_OverTrain/sst_OverTrain,
                                                1 - sse_Reg_OverValid/sst_OverValid ) )
  
Results_Models  

```


```{r plot_Valid, warning=FALSE}

advertising_Valid_3 <- melt(advertising_Valid[ , c("sales", "Reg_02", "Reg_OverValid")], 
                      id='sales')

names(advertising_Valid_3) <- c("Sales", "Model", "Predict")

ggplot(data = advertising_Valid_3, aes(x = Predict, y = Sales, color = Model)) + 
  geom_point(size = 2, alpha = 0.5) +
  theme_ipsum() + #theme_bw() 
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank()) +
  guides(col = guide_legend(nrow = 1, byrow = TRUE)) + 
  xlab("Gasto en publicidad") + 
  ylab("Ventas") + 
  theme(plot.title = element_text(size = 11, face = "bold", hjust = 0)) + 
  theme(plot.subtitle = element_text(size = 10, hjust = 0)) + 
  theme(plot.caption = element_text(hjust = 0)) +
  theme(plot.margin = unit(c(1,1,1,1), "cm")) +
  labs(
    title = "Comparación del desempeño de los modelos",
    subtitle = "Valores en pesos",
    caption = "Fuente: Elaboración propia."
  )

```
